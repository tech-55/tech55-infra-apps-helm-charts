name: Release Helm Chart

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allows manual triggering

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # important: we need full git history

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.2  # latest stable Helm version

      - name: Package Helm chart
        run: |
          mkdir -p charts
          helm package . -d charts

      - name: Update Helm repo index
        run: |
          helm repo index charts --url https://tech-55.github.io/tech55-infra-apps-helm-charts

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: charts
